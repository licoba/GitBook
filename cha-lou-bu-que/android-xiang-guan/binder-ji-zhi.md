---
description: Binder的原理分析、跨进程通信
---

# Binder机制

### 为什么要有Binder机制？

首先需要提到**AMS**（Activity Manager Service ）AMS是Android的系统服务，应用进程的启动、切换和调度、四大组件的启动和管理都需要AMS的支持。翻译过来就是活动管理服务，注意到这是一个服务，属于Android系统级的一个进程。

但是Andrioid App需要与AMS之间进行通信，AMS和Activity不在同一个进程，那么就肯定需要用到IPC机制，Android里面的进程间通信，那么就是通过Binder来实现的。

大型App都是多进程，小App只有一个进程就可以搞定。

### 为什么要用多进程？

因为Android虚拟机单个进程的内存分配是有限制的，比如要加载图库，比如使用WebView打开网页等等，这些操作会占用很大内存，可以单独拆分这个进程出来。其次是进程隔离，可以保证功能稳定性，一个进程挂了不会影响另一个进程。

### 用户空间和内核空间

**内核空间** 是 Linux 内核的运行空间，可以执行任意指令，直接调用系统的资源。

**用户空间** 是用户程序的运行空间，需要通过native的API，才能够访问系统资源。

每个进程拥有用户空间和内核空间，用户空间是每个进程独有的，内核空间是线程之间可以共享的。

#### Q：为什么要划分内核空间和用户空间呢？

因为如果每个进程能够访问任意的内存，常常容易把系统搞崩掉，一个进程可能会直接影响到其它进程甚至是整个系统运行。所以需要划分两个不同的内存区域，并且让他们互相隔离，即使用户的程序崩溃了，内核也不受影响。

### Binder有什么优势？

Android是基于Linux的，Linux其实本身也有一些IPC机制：管道、socket、消息队列、共享内存，这些都是Linux自带的进程，那为什么Android还要单独搞一个Binder用来通信呢？

首先，进程之间的内存是不共享的，A进程没有办法直接操作B进程里面的内存。但是我们上面有提到过，内核空间是可以共享的，所以进程间就可以通过内核空间来进行通信。

传统的IPC机制，例如Socket，需要通过**两次拷贝**，来在进程间传递数据：比如A进程要传递数据到B进程，A进程需要将自己的数据copy到内核空间，然后B进程再将传递的数据copy到自己的用户空间，总共就是两次拷贝。

而Binder基于C/S架构，只用**拷贝一次内存**。

既然提到了拷贝内存的次数，就必须要提一下共享内存，共享内存不用copy就能够直接共享数据。但是就和多线程一样，如果使用共享内存，那么多进程同时操作一块内存，就会涉及到多进程的同步问题。多进程不像多线程一样，有一套很好的同步机制。没有同步手段，多进程就很容易出现死锁等问题。

Binder机制还提供了一套UID，这个UID是Android系统为每一个进程分配的独一无二的、**可靠的**ID，使用UID来鉴别进程的身份，这个UID不能由进程自己修改，就保证了安全性。

这里要提到一点，为什么传统的IPC（套接字、管道、消息队列）的UID是不可靠的呢？因为传统的IPC，UID可以由进程自己在数据包里面填入值，也就是说其它恶意进程也可以通过伪造UID来伪造一个进程。

### Binder是怎么做到一次拷贝的？

Binder机制可以理解为，让**用户空间**与**内核空间**之间，有了一块**共享的内存空间** 

所以A进程在拷贝数据到内核空间之后，B进程就可以直接从共享内存拿到传过来的数据了，发送方发送到共享内存之后，接收方可以直接取用。

共享内存是Linux上就存在的技术，Binder就使用了这种技术。

共享内存，使用的是**mmap**技术。大致来讲，就是在**物理内存**上面划分了一块空间，用户空间和内核空间同时**映射**到了同一块物理内存空间（注意，用户空间和内核空间实际上都是虚拟内存，**内存映射就是将虚拟内存影射到物理内存**）所以他们就可以在这块空间上共享数据。



【参考文章】

* [哔哩哔哩「Binder大厂面试题」](https://www.bilibili.com/video/BV13A411J7i4?p=3&spm_id_from=pageDriver)





