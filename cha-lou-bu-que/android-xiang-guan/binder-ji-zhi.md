---
description: Binder源码分析、IPC
---

# Binder机制

### 为什么要有Binder机制？

首先需要提到**AMS**（Activity Manager Service ）AMS是Android的系统服务，应用进程的启动、切换和调度、四大组件的启动和管理都需要AMS的支持。翻译过来就是活动管理服务，注意到这是一个服务，属于Android系统级的一个进程。

但是Andrioid App需要与AMS之间进行通信，AMS和Activity不在同一个进程，那么就肯定需要用到IPC机制，Android里面的进程间通信，那么就是通过Binder来实现的。

大型App都是多进程，小App只有一个进程就可以搞定。

### 为什么要用多进程？

因为Android虚拟机单个进程的内存分配是有限制的，比如要加载图库，比如使用WebView打开网页等等，这些操作会占用很大内存，可以单独拆分这个进程出来。其次是进程隔离，可以保证功能稳定性，一个进程挂了不会影响另一个进程。

### 用户空间和内核空间

**内核空间** 是 Linux 内核的运行空间，可以执行任意指令，直接调用系统的资源。

**用户空间** 是用户程序的运行空间，需要通过native的API，才能够访问系统资源。

每个进程拥有用户空间和内核空间，用户空间是每个进程独有的，内核空间是线程之间可以共享的。

#### Q：为什么要划分内核空间和用户空间呢？

因为如果每个进程能够访问任意的内存，常常容易把系统搞崩掉，一个进程可能会直接影响到其它进程甚至是整个系统运行。所以需要划分两个不同的内存区域，并且让他们互相隔离，即使用户的程序崩溃了，内核也不受影响。

### Binder有什么优势？

Android是基于Linux的，Linux其实本身也有一些IPC机制：管道、socket、消息队列、共享内存，这些都是Linux自带的进程，那为什么Android还要单独搞一个Binder用来通信呢？

首先，进程之间的内存是不共享的，A进程没有办法直接操作B进程里面的内存。但是我们上面有提到过，内核空间是可以共享的，所以进程间就可以通过内核空间来进行通信。

传统的IPC机制，例如Socket，需要通过**两次拷贝**，来在进程间传递数据：比如A进程要传递数据到B进程，A进程需要将自己的数据copy到内核空间，然后B进程再将传递的数据copy到自己的用户空间，总共就是两次拷贝。

而Binder基于C/S架构，只用**拷贝一次内存**。

既然提到了拷贝内存的次数，就必须要提一下共享内存，共享内存不用copy就能够直接共享数据。但是就和多线程一样，如果使用共享内存，那么多进程同时操作一块内存，就会涉及到多进程的同步问题。多进程不像多线程一样，有一套很好的同步机制。没有同步手段，多进程就很容易出现死锁等问题。





